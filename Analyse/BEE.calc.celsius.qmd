---
title: "BEE.calc.celsius"
author: "Victoria"
format: html
editor: visual
---

This funciton check that the spat rasters unit for temperature is Celsius, if not it does the convertion from kelvin to celsius or return an error message if the unit is not Celsius or Kelvin. It is design for '.nc' files.

```{r}
BEE.calc.celsius <- function(YourSpatRaster) {
  # Get the unit of each layer.
  units_count <- units(YourSpatRaster)
  # Check that no layer contain several unit.
  if (any(sapply(units_count, length) != 1)) {
    warning("No unit or multiple units were detected for some layers. Plot raster[[1]] to verify if a unit is provided, and ensure that there are no multiple values assigned to a single pixel in your raster.")
    return(NULL)
  }
  # Check that all layers have the same unit.
  unit <- unique(units_count)
  if (length(unit) > 1) {
    warning("Units differ between layers. If you have merged layers from different datasets, ensure that all layers measure the same parameter and that the units are consistent across datasets before merging.")
    return(NULL)
  }
  
  # Check that the unit is not already Celsius
  if (unit %in% c("Celsius", "celsius", "°C", "°c", "c", "C")) {
    print("Your dataset is already in celsius, there is no need to use this function.")
    return(NULL)
  }
  # Store original metadata for later
  original_metadata <- list(
    time = time(YourSpatRaster), 
    crs = crs(YourSpatRaster),    
    extent = ext(YourSpatRaster)  
  )
  # Convert from kelvin to celsius
  if (tolower(unit) %in% c("kelvin", "k")) {
    YourSpatRaster <- app(YourSpatRaster, function(x) x - 273.15)  # conversion en celsius
    units(YourSpatRaster) <- "Celsius" # This unfortunately delete other metadata
    #restore other metadata
    time(YourSpatRaster) <- original_metadata$time
    crs(YourSpatRaster) <- original_metadata$crs
    ext(YourSpatRaster) <- original_metadata$extent
    warning("Your data were in Kelvin and have been converted to Celsius using: former value - 273.15 = new value.")
    return(YourSpatRaster)
  }
  # Convert from Fahrenheit to celsius
  if (tolower(unit) %in% c("fahrenheit", "f")) {
    YourSpatRaster <- app(YourSpatRaster, function(x) round((x - 32) * (5 / 9), digits = 3))  # conversion en celsius
    units(YourSpatRaster) <- "Celsius" # This unfortunately delete other metadata
    #restore other metadata
    time(YourSpatRaster) <- original_metadata$time
    crs(YourSpatRaster) <- original_metadata$crs
    ext(YourSpatRaster) <- original_metadata$extent
    warning("Your data were in Fahrenheit and have been converted to Celsius using: round((former value - 32)*(5/9), digits = 3) = new value.")
    return(YourSpatRaster)
  }
  
  warning("The unit of your dataset is not recognized.")
  return(NULL)
}

```
