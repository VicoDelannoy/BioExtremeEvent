---
title: "BEE.calc.baseline"
author: "Victoria"
format: html
editor: visual
---

\#'@description *BEE.calc.baseline* : Creates a baseline from a SpatRaster by compiling cell data according to the chosen threshold

Only two threshold can be set :

-   "*qt*" : calculate the value of the 90th percentile for each cell at the time resolution of the dataset. For instance, it calculate the value of the threshold for each day of a theoretical year if the data has a daily resolution or for each month if data has a monthly resolution. To simplify analysis, the 29th of February is deleted if present.
-   "*mean*" : calculate the mean value for each cell at the time resolution of the data set .

```{r}
# rast_name = ds ; end_date = "2010-12-31" ; threshold = "qt"; quantile_value = 0.9

BEE.calc.baseline <- function(rast_name, start_date=NULL, end_date=NULL, threshold, quantile_value){
  
  # Subset the dataset to the chosen strat_date and end-date if necessary
  if (!is.null(start_date) | !is.null(end_date)){
    if ( is.null(start_date) ){
      start_date <- names(rast_name)[1]
      warning("You have provided an 'end_date' but no 'start_date', first date of the dataset (",start_date,") have been used as first day of the baseline."  )
    }
    if ( is.null(end_date) ){
      end_date <- names(rast_name)[nlyr(rast_name)]
      warning("You have provided a 'start_date' but no 'end_date', last date of the dataset (", end_date,") have been used as last day of the baseline."  )
    }
    layer_dates <- as.Date(names(ds))
    selected_layers <- which(layer_dates >= start_date & layer_dates <= end_date)
    rast_name <- ds[[selected_layers]]
  }

  ncor = detectCores()-2                # count how many cores there are in the system and ask to use all of them except 2
  cl =makeCluster(ncor)                 # create a cluster to do calculation in parallel using ncor
  
  if (threshold == "qt"){             # check which threshold was asked by the operator
    if (is.null(quantile_value))
    {return("Error : if you want to calculate the quantile at each point you need to precise which quantile in the argument : ex : quantile_value=90 for the 90th quantile. If you want to calculate the mean, use threshold='mean'.")}
    if (quantile_value < 0 | quantile_value >1){
      return("Error : 'quantile_value' argument must be between 0 and 1")}
    q =  function(x, na.rm = TRUE){   # define a function 'q' to estimate the value of the quantile value  for each pixel of the raster (x must be a raster), NA are delete before calculation
      return(quantile(x,quantile_value,na.rm=na.rm)) #quantile needs several arguments so it would be confusing to have this function directly in tapp + tapp is not directly compatible with complex function
    }
    baseline <- tapp(rast_name,index = "doy", fun = q, cores = cl) #tapp is a function from terra package that apply a function (here q) to the group of values from the same day of the year across all years available
    stopCluster(cl)}                    # close core cluster
  
  else if (threshold == "mean"){        # if the baseline chosen is a mean value then enter loop bellow
    baseline <- tapp(rast_name,index = "doy", fun = mean, cores = cl) #directly uses the mean option already existing in tapp function
    stopCluster(cl)}                    # close core cluster
  return(baseline)
}
```
