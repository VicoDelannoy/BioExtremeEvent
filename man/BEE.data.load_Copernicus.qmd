---
title: "BEE.data.load_Copernicus"
author: "Victoria"
format: html
editor: visual
---

This function is a wrapper from the CopernicusMarine function from pyhton. A pyhton setup must be present in your computer, thus this function is testing if some pyhton is present and if not it offer to download it from R.

```{r}
BEE.data.load_Copernicus <- function(username, 
                                     password, 
                                dataset_id, 
                                dataset_version, 
                            variables,
                        minimum_longitude,
                        maximum_longitude,
                        minimum_latitude,
                        maximum_latitude,
                  start_datetime,
                  end_datetime,
            coordinates_selection_method="strict-inside",
    disable_progress_bar=FALSE,
    output_directory = here::here("Data")){
  
    # Create a virtual Python space and connect to Copernicus API
    virtualenv_create(envname = "CopernicusMarine")
    virtualenv_install("CopernicusMarine", packages = c("copernicusmarine"))
    reticulate::use_virtualenv("CopernicusMarine", required = TRUE)
    py_install("copernicusmarine", pip = TRUE)
    # Check that it work, usually, if it doesn't works it is because Pyhton is nowhere in the system.
    version <- system("python3 --version", intern = TRUE)
  
  if (length(version) == 0) {
    version <- system("python3 --version", intern = TRUE)
    user_response <- tolower(readline(prompt = "No Python version was found on your device. Python is required to use the CopernicusMarine interface, which allows downloading Marine Copernicus datasets from R. Would you like to install Python in a virtual environment within the 'reticulate' package? This process will take approximately 5 minutes and needs to be done only once. (Yes/No):"))
    if (user_response == "YES" || user_response == "yes") {
      install_python(version = "3.10")
      version <- reticulate::py_config()
      print(version)
      # Create a virtual Python space and connect to Copernicus API
      virtualenv_create(envname = "CopernicusMarine")
      virtualenv_install("CopernicusMarine", packages = c("copernicusmarine"))
      reticulate::use_virtualenv("CopernicusMarine", required = TRUE)
      py_install("copernicusmarine", pip = TRUE)
    }
    if (user_response == "NO" || user_response == "No"){
      return("At last update, Copernicus Marine data center has not provided an API that allows downloding directly from R, thus creating a virutal pyhton environment is necessary. If you want to download a small area or a short time window, you may consider downloding rasters directly on https://data.marine.copernicus.eu/ . Both methods work well with the other functions.")
    }
  }
  if (length(version) > 0) {
    cm <- import("copernicusmarine")
    cm$login(username, password)
    
    # Get the data
  ds <- cm$subset(
    dataset_id = dataset_id,
    dataset_version = dataset_version,
    variables= list(gsub(pattern = "[\\[\\]]", replacement = "", variables)),
    minimum_longitude=minimum_longitude,
    maximum_longitude=maximum_longitude,
    minimum_latitude=minimum_latitude,
    maximum_latitude=maximum_latitude,
    start_datetime=start_datetime,
    end_datetime=end_datetime,
    coordinates_selection_method=coordinates_selection_method,
    disable_progress_bar=disable_progress_bar,
    output_directory = output_directory
  )
  } 
}
```
